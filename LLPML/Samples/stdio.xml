<?xml version="1.0" encoding="utf-8" ?>
<llpml version="0.4.20070816">

<!-- stdio functions -->

<extern name="GetStdHandle" module="kernel32.dll" type="std" />
<extern name="ReadConsole" alias="ReadConsoleW" module="kernel32.dll" type="std" />
<extern name="WriteConsole" alias="WriteConsoleW" module="kernel32.dll" type="std" />
<extern name="lstrlen" alias="lstrlenW" module="kernel32.dll" type="std" />
<extern name="wvsprintf" alias="wvsprintfW" module="user32.dll" type="std" />

<int-declare name="STD_OUTPUT_HANDLE">-11</int-declare>
<int-declare name="STD_INPUT_HANDLE">-10</int-declare>

<var-int-declare name="stdout" />
<var-int-declare name="stdin" />

<let>
	<var-int name="stdout" />
	<call name="GetStdHandle">
		<int name="STD_OUTPUT_HANDLE" />
	</call>
</let>
<let>
	<var-int name="stdin" />
	<call name="GetStdHandle">
		<int name="STD_INPUT_HANDLE" />
	</call>
</let>

<function name="print">
	<arg-int name="text" />
	<var-int-declare name="dummy" />
	<call name="WriteConsole">
		<var-int name="stdout" />
		<var-int name="text" />
		<call name="lstrlen">
			<var-int name="text" />
		</call>
		<var-int-ptr name="dummy" />
		<int>0</int>
	</call>
</function>

<function name="vprintf">
	<arg-int name="format" />
	<arg-int name="args" />
	<ptr-declare name="buffer" type="char" length="1025" />
	<call name="wvsprintf">
		<ptr name="buffer" />
		<var-int name="format" />
		<var-int name="args" />
	</call>
	<call name="print">
		<ptr name="buffer" />
	</call>
</function>

<function name="vprintfln">
	<arg-int name="format" />
	<arg-int name="args" />
	<call name="vprintf">
		<var-int name="format" />
		<var-int name="args" />
	</call>
	<call name="println" />
</function>

<function name="printf">
	<arg-int name="format" />
	<arg-ptr name="args" />
	<call name="vprintf">
		<var-int name="format" />
		<ptr name="args" />
	</call>
</function>

<function name="println">
	<call name="print">
		<string>
</string>
	</call>
</function>

<function name="printfln">
	<arg-int name="format" />
	<arg-ptr name="args" />
	<call name="vprintf">
		<var-int name="format" />
		<ptr name="args" />
	</call>
	<call name="println" />
</function>

<function name="pause">
	<var-int-declare name="dummy" />
	<ptr-declare name="buffer" type="char" length="16" />
	<call name="ReadConsole">
		<var-int name="stdin" />
		<ptr name="buffer" />
		<int>1</int>
		<var-int-ptr name="dummy" />
		<int>0</int>
	</call>
</function>

<function name="finish">
	<call name="println" />
	<call name="printfln">
		<string>Press [Enter] to exit.</string>
	</call>
	<call name="pause" />
</function>

</llpml>
