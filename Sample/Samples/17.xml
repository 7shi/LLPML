<?xml version="1.0" encoding="utf-8" ?>
<llpml version="0.10.20080203" subsystem="WINDOWS_GUI">

<!-- window -->

<include src="stdio.xml" />
<include src="win32.xml" />

<?llpml
const string className = "LLPML Test Window";
var hInstance = GetModuleHandle();

WNDCLASSEX wcex =
{
  /* cbSize        */ sizeof(WNDCLASSEX),
  /* style         */ CS_VREDRAW | CS_HREDRAW,
  /* lpfnWndProc   */ addrof(WndProc),
  /* cbClsExtra    */ 0,
  /* cbWndExtra    */ 0,
  /* hInstance     */ hInstance,
  /* hIcon         */ null,
  /* hCursor       */ LoadCursor(null, IDC_ARROW),
  /* hbrBackground */ COLOR_WINDOW + 1,
  /* lpszMenuName  */ null,
  /* lpszClassName */ className,
  /* hIconSm       */ null
};
RegisterClassEx(wcex);

var hWnd = CreateWindowEx(
  /* dwExStyle    */ 0,
  /* lpClassName  */ className,
  /* lpWindowName */ "テスト",
  /* dwStyle      */ WS_OVERLAPPEDWINDOW,
  /* X            */ CW_USEDEFAULT,
  /* Y            */ 0,
  /* nWidth       */ 256,
  /* nHeight      */ 256,
  /* hWndParent   */ null,
  /* hMenu        */ null,
  /* hInstance    */ hInstance,
  /* lpParam      */ null
);
ShowWindow(hWnd, SW_SHOWNORMAL);
UpdateWindow(hWnd);

MSG msg;
while (GetMessage(msg, null, 0, 0))
{
  TranslateMessage(msg);
  DispatchMessage(msg);
}

DestroyWindow(hWnd);

function __stdcall WndProc(hWnd, msg, wParam, lParam)
{
  switch (msg)
  {
    case WM_PAINT:
    {
      PAINTSTRUCT ps;
      var hdc = BeginPaint(hWnd, ps);
      TextOut(hdc, 8, 8, className, lstrlen(className));
      EndPaint(hWnd, ps);
      break;
    }
    case WM_LBUTTONDOWN:
      MyFillRect();
      break;
    case WM_RBUTTONDOWN:
      InvalidateRect(hWnd, null, true);
      break;
    case WM_MOUSEMOVE:
      if (wParam & MK_LBUTTON) MyFillRect();
      break;
    case WM_DESTROY:
      PostQuitMessage(0);
      break;
    default:
      return DefWindowProc(hWnd, msg, wParam, lParam);
  }
  return 0;
  
  // 関数内関数
  function MyFillRect()
  {
    var hdc = GetDC(hWnd);
    var brush = GetSysColorBrush(COLOR_WINDOWTEXT);
    var x = GET_X_LPARAM(lParam);
    var y = GET_Y_LPARAM(lParam);
    RECT rect = { x - 2, y - 2, x + 2, y + 2 };
    FillRect(hdc, rect, brush);
  }
}
?>

</llpml>
